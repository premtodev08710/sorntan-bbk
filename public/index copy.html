<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏Ñ‡∏£‡∏π</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .timetable-cell { min-height:60px; border:1px solid #e5e7eb; padding:8px; text-align:center; vertical-align:middle; background:white; transition:all .2s; }
        .timetable-cell:hover { background:#f3f4f6; }
        .timetable-cell:focus { outline:2px solid #3b82f6; background:#eff6ff; }
        .day-header { background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:white; font-weight:600; padding:12px; text-align:center; }
        .period-header { background:linear-gradient(135deg,#10b981,#059669); color:white; font-weight:600; padding:12px; text-align:center; writing-mode:vertical-rl; text-orientation:mixed; }
        .tab-button { transition:all .3s ease; }
        .tab-button.active { background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:white; transform:translateY(-2px); box-shadow:0 4px 12px rgba(59,130,246,.3); }
        @media print{
          .no-print{display:none!important;}
          @page{size:A4 landscape; margin:1cm;}
          body{font-size:12px;}
          .print-table{width:100%; border-collapse:collapse;}
          .print-table th,.print-table td{border:1px solid #000; padding:4px; text-align:center;}
        }
        .gradient-bg{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
        .card-shadow{box-shadow:0 10px 25px rgba(0,0,0,.1);}
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <div class="gradient-bg text-white py-6 shadow-lg">
    <div class="container mx-auto px-4">
      <h1 class="text-3xl font-bold text-center">üè´ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏Ñ‡∏£‡∏π</h1>
      <p class="text-center mt-2 opacity-90">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</p>
    </div>
  </div>

  <!-- Tabs -->
  <div class="container mx-auto px-4 mt-6">
    <div class="flex space-x-2 bg-white rounded-lg p-2 card-shadow">
      <button id="tab-regular" class="tab-button flex-1 py-3 px-6 rounded-lg font-medium transition-all active">üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥</button>
      <button id="tab-substitute" class="tab-button flex-1 py-3 px-6 rounded-lg font-medium transition-all bg-gray-100 hover:bg-gray-200">üîÑ ‡∏à‡∏±‡∏î‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
  </div>

  <!-- Regular Timetable -->
  <div id="regular-tab" class="container mx-auto px-4 mt-6">
    <div class="bg-white rounded-lg card-shadow p-6">
      <div class="mb-6">
        <div class="flex flex-wrap gap-4 items-center">
          <div class="flex-1 min-w-64">
            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π</label>
            <select id="teacherSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π --</option>
            </select>
          </div>
          <button id="addTeacher" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>

      <div id="teacherNameSection" class="mb-6 hidden">
        <div class="flex gap-4 items-end">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π</label>
            <input type="text" id="teacherName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π">
          </div>
          <button id="saveTeacherName" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
        </div>
      </div>

      <div id="timetableSection" class="hidden">
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-gray-800">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</h3>
          <p class="text-sm text-gray-600">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.3")</p>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden">
            <thead>
              <tr>
                <th class="day-header border border-gray-300">‡∏ß‡∏±‡∏ô / ‡∏Ñ‡∏≤‡∏ö</th>
                <th class="period-header border border-gray-300">‡∏Ñ‡∏≤‡∏ö 1<br><small>08:30-09:30</small></th>
                <th class="period-header border border-gray-300">‡∏Ñ‡∏≤‡∏ö 2<br><small>09:30-10:30</small></th>
                <th class="period-header border border-gray-300">‡∏Ñ‡∏≤‡∏ö 3<br><small>10:30-11:30</small></th>
                <th class="period-header border border-gray-300">‡∏Ñ‡∏≤‡∏ö 4<br><small>12:30-13:30</small></th>
                <th class="period-header border border-gray-300">‡∏Ñ‡∏≤‡∏ö 5<br><small>13:30-14:30</small></th>
                <th class="period-header border border-gray-300">‡∏Ñ‡∏≤‡∏ö 6<br><small>14:30-15:30</small></th>
              </tr>
            </thead>
            <tbody id="timetableGrid"></tbody>
          </table>
        </div>

        <div class="mt-6 flex flex-wrap gap-3">
          <button id="saveGrid" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô</button>
          <button id="clearGrid" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-medium">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏Ñ‡∏£‡∏π‡∏ô‡∏µ‡πâ)</button>
          <button id="deleteTeacher" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg font-medium">‚ùå ‡∏•‡∏ö‡∏Ñ‡∏£‡∏π‡∏ô‡∏µ‡πâ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Substitute -->
  <div id="substitute-tab" class="container mx-auto px-4 mt-6 hidden">
    <div class="bg-white rounded-lg card-shadow p-6">
      <div class="grid md:grid-cols-2 gap-6 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" id="subDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
          <select id="absentTeacher" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î --</option>
          </select>
        </div>
      </div>

      <button id="genSub" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-medium mb-6">üîç ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô + ‡∏ú‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏á</button>

      <div id="subTasks" class="hidden mb-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏≤‡∏Ñ‡∏ô‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h3>
        <div class="overflow-x-auto">
          <table class="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden">
            <thead>
              <tr class="bg-gray-50">
                <th class="border border-gray-300 px-4 py-2 text-left">‡∏Ñ‡∏≤‡∏ö</th>
                <th class="border border-gray-300 px-4 py-2 text-left">‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th class="border border-gray-300 px-4 py-2 text-left">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤/‡∏ä‡∏±‡πâ‡∏ô</th>
                <th class="border border-gray-300 px-4 py-2 text-left">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</th>
                <th class="border border-gray-300 px-4 py-2 text-center">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="subTasksBody"></tbody>
          </table>
        </div>
      </div>

      <div id="assignmentSummary" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</h3>
          <div class="flex gap-2">
            <button id="printAssignment" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium no-print">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
            <button id="exportCSV" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium no-print">üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table id="assignmentTable" class="w-full border-collapse border border-gray-300 rounded-lg overflow-hidden print-table">
            <thead>
              <tr class="bg-gray-50">
                <th class="border border-gray-300 px-4 py-2 text-left">‡∏Ñ‡∏≤‡∏ö</th>
                <th class="border border-gray-300 px-4 py-2 text-left">‡πÄ‡∏ß‡∏•‡∏≤</th>
                <th class="border border-gray-300 px-4 py-2 text-left">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤/‡∏ä‡∏±‡πâ‡∏ô</th>
                <th class="border border-gray-300 px-4 py-2 text-left">‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô</th>
              </tr>
            </thead>
            <tbody id="assignmentBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase + App (module) -->
  <script type="module">
    // ===== Firebase SDK (v10 modular) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getFirestore, collection, doc, getDocs, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // **** ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤ ****
    const firebaseConfig = {
      apiKey: "AIzaSyDnRSLFFEtP5cPXbbGfWe3p1PAGhlvFYr4",
      authDomain: "mvp-wsk.firebaseapp.com",
      projectId: "mvp-wsk",
      storageBucket: "mvp-wsk.firebasestorage.app",
      messagingSenderId: "90126949097",
      appId: "1:90126949097:web:02844bcd1b6d662d042e78",
      measurementId: "G-HF6SDL29R7"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ===== Constants (‡πÄ‡∏ß‡∏•‡∏≤/‡∏ß‡∏±‡∏ô) =====
    const PERIODS = [1,2,3,4,5,6];
    const PERIOD_TIME = {1:"08:30-09:30",2:"09:30-10:30",3:"10:30-11:30",4:"12:30-13:30",5:"13:30-14:30",6:"14:30-15:30"};
    const DAYS = ["‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ","‡∏®‡∏∏‡∏Å‡∏£‡πå"];

    // ===== In-memory state (sync ‡∏à‡∏≤‡∏Å Firestore) =====
    let store = { teachers: [] };

    // ===== Utilities =====
    function createEmptyGrid(){
      const grid={}; DAYS.forEach(d=>{ grid[d]={}; PERIODS.forEach(p=>grid[d][p]="");});
      return grid;
    }

    function dayNameFromDateStr(dateStr){
      const date = new Date(dateStr + "T00:00:00");
      const idx = date.getDay(); // 0=‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå
      const names = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå','‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå','‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£','‡∏û‡∏∏‡∏ò','‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ','‡∏®‡∏∏‡∏Å‡∏£‡πå','‡πÄ‡∏™‡∏≤‡∏£‡πå'];
      return names[idx];
    }

    function renderGrid(teacherId){
      const teacher = store.teachers.find(t=>t.id===teacherId);
      if(!teacher) return;
      const tbody = document.getElementById('timetableGrid');
      tbody.innerHTML = '';

      DAYS.forEach(day=>{
        const tr = document.createElement('tr');

        const dayCell = document.createElement('td');
        dayCell.className = 'day-header border border-gray-300';
        dayCell.textContent = day;
        tr.appendChild(dayCell);

        PERIODS.forEach(period=>{
          const td = document.createElement('td');
          td.className = 'timetable-cell';
          td.contentEditable = true;
          td.dataset.day = day;
          td.dataset.period = period;
          td.textContent = teacher.grid?.[day]?.[period] || '';
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    function freeTeachersAt(day, period, excludeId){
      return store.teachers.filter(t=>{
        if(t.id===excludeId) return false;
        const s = t.grid?.[day]?.[period] || '';
        return s.trim()==='';
      });
    }

    function populateTeacherSelect(){
      const select = document.getElementById('teacherSelect');
      const absentSelect = document.getElementById('absentTeacher');
      select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π --</option>';
      absentSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î --</option>';

      store.teachers.forEach(t=>{
        select.add(new Option(t.name, t.id));
        absentSelect.add(new Option(t.name, t.id));
      });
    }

    // ===== Firestore I/O =====
    const teachersCol = collection(db, 'teachers');

    async function seedIfEmpty(){
      const snap = await getDocs(teachersCol);
      if(!snap.empty) return;

      const sample = [
        { id:"t001", name:"‡∏Ñ‡∏£‡∏π‡πÄ‡∏õ‡∏£‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå", grid:{
          "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå":{1:"‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.2",2:"‡∏´‡∏ô‡∏π‡∏ô‡πâ‡∏≠‡∏¢ IT / ‡∏õ.3",3:"",4:"‡∏´‡∏ô‡∏π‡∏ô‡πâ‡∏≠‡∏¢ IT",5:"",6:""},
          "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£":{1:"‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û / ‡∏õ.4",2:"",3:"‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.6",4:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì / ‡∏õ.4",5:"‡∏ä‡∏°‡∏£‡∏°",6:"Codekids digital"},
          "‡∏û‡∏∏‡∏ò":{1:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì / ‡∏õ.5",2:"",3:"",4:"‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û",5:"",6:"‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå"},
          "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ":{1:"",2:"‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.2",3:"",4:"‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ô‡∏≤",5:"‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û",6:"‡∏¢‡∏∏‡∏ß‡∏Å‡∏≤‡∏ä‡∏≤‡∏î"},
          "‡∏®‡∏∏‡∏Å‡∏£‡πå":{1:"",2:"‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.6",3:"",4:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì / ‡∏õ.6",5:"Reading For fun",6:""}
        }},
        { id:"t002", name:"‡∏Ñ‡∏£‡∏π‡∏™‡∏°‡∏ä‡∏≤‡∏¢", grid:{
          "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå":{1:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.1",2:"",3:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.2",4:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.3",5:"‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡πÄ‡∏™‡∏∑‡∏≠",6:""},
          "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£":{1:"",2:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.4",3:"",4:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.5",5:"",6:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.6"},
          "‡∏û‡∏∏‡∏ò":{1:"",2:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.1",3:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.2",4:"",5:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.3",6:""},
          "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ":{1:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.4",2:"",3:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.5",4:"",5:"",6:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.6"},
          "‡∏®‡∏∏‡∏Å‡∏£‡πå":{1:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.1",2:"",3:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.2",4:"",5:"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ / ‡∏õ.3",6:"‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏û‡∏¥‡πÄ‡∏®‡∏©"}
        }},
        { id:"t003", name:"‡∏Ñ‡∏£‡∏π‡∏°‡∏≤‡∏•‡∏µ", grid:{
          "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå":{1:"",2:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.1",3:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.2",4:"",5:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.3",6:"English Club"},
          "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£":{1:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.4",2:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.5",3:"",4:"",5:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.6",6:""},
          "‡∏û‡∏∏‡∏ò":{1:"",2:"",3:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.1",4:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.2",5:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.3",6:""},
          "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ":{1:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.4",2:"",3:"",4:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.5",5:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.6",6:""},
          "‡∏®‡∏∏‡∏Å‡∏£‡πå":{1:"",2:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.1",3:"",4:"‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© / ‡∏õ.2",5:"",6:"English Camp"}
        }},
        { id:"t004", name:"‡∏Ñ‡∏£‡∏π‡∏™‡∏∏‡∏î‡∏≤", grid:{
          "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå":{1:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.4",2:"",3:"",4:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.5",5:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.6",6:""},
          "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£":{1:"",2:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.1",3:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.2",4:"",5:"",6:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.3"},
          "‡∏û‡∏∏‡∏ò":{1:"",2:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.4",3:"",4:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.5",5:"",6:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.6"},
          "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ":{1:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.1",2:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.2",3:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.3",4:"",5:"",6:""},
          "‡∏®‡∏∏‡∏Å‡∏£‡πå":{1:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.4",2:"",3:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.5",4:"",5:"‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå / ‡∏õ.6",6:"‡∏ä‡∏°‡∏£‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå"}
        }},
        { id:"t005", name:"‡∏Ñ‡∏£‡∏π‡∏ß‡∏¥‡∏ä‡∏±‡∏¢", grid:{
          "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå":{1:"",2:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.1",3:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.2",4:"",5:"",6:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.3"},
          "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£":{1:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.4",2:"",3:"",4:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.5",5:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.6",6:""},
          "‡∏û‡∏∏‡∏ò":{1:"",2:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.1",3:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.2",4:"",5:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.3",6:""},
          "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ":{1:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.4",2:"",3:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.5",4:"",5:"",6:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.6"},
          "‡∏®‡∏∏‡∏Å‡∏£‡πå":{1:"",2:"",3:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.1",4:"‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ / ‡∏õ.2",5:"",6:"‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏±‡∏á‡∏Ñ‡∏°"}
        }},
        { id:"t006", name:"‡∏Ñ‡∏£‡∏π‡∏ô‡∏¥‡∏†‡∏≤", grid:{
          "‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå":{1:"",2:"",3:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.1",4:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.2",5:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.3",6:""},
          "‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£":{1:"",2:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.4",3:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.5",4:"",5:"",6:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.6"},
          "‡∏û‡∏∏‡∏ò":{1:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.1",2:"",3:"",4:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.2",5:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.3",6:""},
          "‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ":{1:"",2:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.4",3:"",4:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.5",5:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.6",6:""},
          "‡∏®‡∏∏‡∏Å‡∏£‡πå":{1:"‡∏®‡∏¥‡∏•‡∏õ‡∏∞ / ‡∏õ.1",2:"",3:"",4:"",5:"",6:"‡∏ä‡∏°‡∏£‡∏°‡∏®‡∏¥‡∏•‡∏õ‡∏∞"}
        }}
      ];

      // ‡πÉ‡∏ä‡πâ setDoc ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î id ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ onSnapshot ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà id ‡πÑ‡∏î‡πâ
      await Promise.all(sample.map(s => setDoc(doc(db,'teachers',s.id), { name:s.name, grid:s.grid } )));
    }

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö: subscribe ‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
    function subscribeTeachers(){
      onSnapshot(teachersCol, (snapshot)=>{
        // map docs -> store.teachers
        store.teachers = snapshot.docs.map(d => ({ id:d.id, ...d.data() }));
        populateTeacherSelect();

        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const currentId = document.getElementById('teacherSelect').value;
        if(currentId){
          const t = store.teachers.find(x=>x.id===currentId);
          if(t){
            document.getElementById('teacherName').value = t.name || '';
            document.getElementById('teacherNameSection').classList.remove('hidden');
            document.getElementById('timetableSection').classList.remove('hidden');
            renderGrid(currentId);
          }
        }
      });
    }

    // ===== Actions (CRUD) =====
    async function addTeacher(){
      const name = prompt('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà:');
      if(!name || !name.trim()) return;
      const grid = createEmptyGrid();
      // ‡πÉ‡∏´‡πâ Firestore ‡∏™‡∏£‡πâ‡∏≤‡∏á id ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      const ref = await addDoc(teachersCol, { name:name.trim(), grid });
      // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
      document.getElementById('teacherSelect').value = ref.id;
      document.getElementById('teacherSelect').dispatchEvent(new Event('change'));
    }

    async function saveTeacherName(){
      const id = document.getElementById('teacherSelect').value;
      const newName = document.getElementById('teacherName').value.trim();
      if(!id || !newName) return;
      await updateDoc(doc(db,'teachers',id), { name:newName });
    }

    async function saveGrid(){
      const id = document.getElementById('teacherSelect').value;
      if(!id) return;
      const teacher = store.teachers.find(t=>t.id===id);
      if(!teacher) return;

      // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å cell ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      const cells = document.querySelectorAll('#timetableGrid .timetable-cell');
      const newGrid = structuredClone(teacher.grid || createEmptyGrid());
      cells.forEach(cell=>{
        const day = cell.dataset.day;
        const period = parseInt(cell.dataset.period);
        if(!newGrid[day]) newGrid[day]={};
        newGrid[day][period] = cell.textContent.trim();
      });
      await updateDoc(doc(db,'teachers',id), { grid:newGrid });

      // UI feedback
      const btn = document.getElementById('saveGrid');
      const old = btn.textContent;
      btn.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
      btn.classList.remove('bg-blue-500'); btn.classList.add('bg-green-500');
      setTimeout(()=>{ btn.textContent = old; btn.classList.remove('bg-green-500'); btn.classList.add('bg-blue-500'); }, 1800);
    }

    async function clearGrid(){
      if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏£‡∏π‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      const id = document.getElementById('teacherSelect').value;
      if(!id) return;
      const empty = createEmptyGrid();
      await updateDoc(doc(db,'teachers',id), { grid:empty });
      renderGrid(id);
    }

    async function deleteTeacher(){
      const id = document.getElementById('teacherSelect').value;
      if(!id) return;
      const t = store.teachers.find(x=>x.id===id);
      if(!t) return;
      if(!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏£‡∏π "${t.name}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;
      await deleteDoc(doc(db,'teachers',id));
      document.getElementById('teacherSelect').value = '';
      document.getElementById('teacherNameSection').classList.add('hidden');
      document.getElementById('timetableSection').classList.add('hidden');
    }

    function generateSubstituteTasks(){
      const dateStr = document.getElementById('subDate').value;
      const absentId = document.getElementById('absentTeacher').value;
      if(!dateStr || !absentId){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î'); return; }

      const dayName = dayNameFromDateStr(dateStr);
      if(!DAYS.includes(dayName)){ alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå'); return; }

      const absentTeacher = store.teachers.find(t=>t.id===absentId);
      if(!absentTeacher) return;

      const tasks = PERIODS.filter(p=>{
        const subj = absentTeacher.grid?.[dayName]?.[p];
        return subj && subj.trim() !== '';
      });
      if(tasks.length===0){ alert('‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≤‡∏ö‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'); return; }

      const tbody = document.getElementById('subTasksBody');
      tbody.innerHTML = '';
      tasks.forEach(period=>{
        const subject = absentTeacher.grid[dayName][period];
        const freeTs = freeTeachersAt(dayName, period, absentId);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="border border-gray-300 px-4 py-2 font-medium">‡∏Ñ‡∏≤‡∏ö ${period}</td>
          <td class="border border-gray-300 px-4 py-2">${PERIOD_TIME[period]}</td>
          <td class="border border-gray-300 px-4 py-2">${subject}</td>
          <td class="border border-gray-300 px-4 py-2">
            <select class="w-full px-2 py-1 border border-gray-300 rounded" data-period="${period}" data-subject="${subject}">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô --</option>
              ${freeTs.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}
            </select>
          </td>
          <td class="border border-gray-300 px-4 py-2 text-center">
            <button class="assign-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm font-medium" data-period="${period}" data-subject="${subject}">
              ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢
            </button>
          </td>`;
        tbody.appendChild(tr);
      });

      document.getElementById('subTasks').classList.remove('hidden');

      document.querySelectorAll('.assign-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const period = this.dataset.period;
          const subject = this.dataset.subject;
          const select = document.querySelector(`select[data-period="${period}"]`);
          const substituteId = select.value;
          if(!substituteId){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô‡πÅ‡∏ó‡∏ô'); return; }
          const substitute = store.teachers.find(t=>t.id===substituteId);
          if(!substitute) return;
          addToAssignmentSummary(period, PERIOD_TIME[period], subject, substitute.name);
          this.closest('tr').remove();
          if(document.querySelectorAll('#subTasksBody tr').length===0){
            document.getElementById('subTasks').classList.add('hidden');
          }
        });
      });
    }

    function addToAssignmentSummary(period, time, subject, substituteName){
      const tbody = document.getElementById('assignmentBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="border border-gray-300 px-4 py-2">‡∏Ñ‡∏≤‡∏ö ${period}</td>
        <td class="border border-gray-300 px-4 py-2">${time}</td>
        <td class="border border-gray-300 px-4 py-2">${subject}</td>
        <td class="border border-gray-300 px-4 py-2">${substituteName}</td>`;
      tbody.appendChild(tr);
      document.getElementById('assignmentSummary').classList.remove('hidden');
    }

    function printAssignment(){ window.print(); }

    function exportCSV(){
      const table = document.getElementById('assignmentTable');
      const rows = table.querySelectorAll('tr');
      let csv = '\uFEFF';
      rows.forEach(r=>{
        const cells = r.querySelectorAll('th,td');
        const row = Array.from(cells).map(c=>`"${c.textContent.trim()}"`).join(',');
        csv += row + '\n';
      });
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `substitute_teaching_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function switchTab(tab){
      document.querySelectorAll('.tab-button').forEach(b=>{ b.classList.remove('active'); b.classList.add('bg-gray-100','hover:bg-gray-200'); });
      document.getElementById('regular-tab').classList.add('hidden');
      document.getElementById('substitute-tab').classList.add('hidden');

      if(tab==='regular'){
        const b = document.getElementById('tab-regular');
        b.classList.add('active'); b.classList.remove('bg-gray-100','hover:bg-gray-200');
        document.getElementById('regular-tab').classList.remove('hidden');
      }else{
        const b = document.getElementById('tab-substitute');
        b.classList.add('active'); b.classList.remove('bg-gray-100','hover:bg-gray-200');
        document.getElementById('substitute-tab').classList.remove('hidden');
      }
    }

    // ===== Boot =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      // seed ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      await seedIfEmpty();

      // subscribe ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
      subscribeTeachers();

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      document.getElementById('subDate').valueAsDate = new Date();

      // Tab events
      document.getElementById('tab-regular').addEventListener('click', ()=>switchTab('regular'));
      document.getElementById('tab-substitute').addEventListener('click', ()=>switchTab('substitute'));

      // Select teacher
      document.getElementById('teacherSelect').addEventListener('change', function(){
        const id = this.value;
        if(id){
          const t = store.teachers.find(x=>x.id===id);
          document.getElementById('teacherName').value = t?.name || '';
          document.getElementById('teacherNameSection').classList.remove('hidden');
          document.getElementById('timetableSection').classList.remove('hidden');
          renderGrid(id);
        }else{
          document.getElementById('teacherNameSection').classList.add('hidden');
          document.getElementById('timetableSection').classList.add('hidden');
        }
      });

      // Buttons
      document.getElementById('addTeacher').addEventListener('click', addTeacher);
      document.getElementById('saveTeacherName').addEventListener('click', saveTeacherName);
      document.getElementById('saveGrid').addEventListener('click', saveGrid);
      document.getElementById('clearGrid').addEventListener('click', clearGrid);
      document.getElementById('deleteTeacher').addEventListener('click', deleteTeacher);
      document.getElementById('genSub').addEventListener('click', generateSubstituteTasks);
      document.getElementById('printAssignment').addEventListener('click', printAssignment);
      document.getElementById('exportCSV').addEventListener('click', exportCSV);
    });
  </script>
</body>
</html>

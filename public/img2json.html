<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OCR ‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô ‚Üí JSON (TH)</title>
<style>
  :root{--b:#0ea5e9;--g:#16a34a;--r:#ef4444;}
  body{font-family:system-ui,-apple-system,'Sarabun',sans-serif;max-width:900px;margin:28px auto;padding:0 16px;}
  h1{font-size:22px;margin:6px 0 16px;}
  .drop{border:2px dashed #94a3b8;border-radius:14px;padding:22px;text-align:center;background:#f8fafc}
  .drop.drag{background:#e0f2fe;border-color:var(--b)}
  .row{display:flex;gap:10px;align-items:center;margin:10px 0;}
  .btn{padding:10px 14px;border:0;border-radius:10px;background:var(--b);color:#fff;cursor:pointer}
  .btn.sec{background:#334155}
  .btn:disabled{opacity:.65;cursor:not-allowed}
  progress{width:100%}
  pre{background:#0b1020;color:#d1e7ff;padding:14px;border-radius:10px;white-space:pre-wrap;max-height:420px;overflow:auto}
  .card{border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:10px 0}
  .small{color:#64748b;font-size:12px}
  .ok{color:var(--g)}
  .err{color:var(--r)}
</style>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body>
  <h1>‡∏ñ‡∏≠‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏≠‡∏ô ‚Üí JSON</h1>
  <div class="drop" id="drop">
    <p><b>‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</b> ‡∏´‡∏£‡∏∑‡∏≠ <label class="btn"><input type="file" id="fileInput" accept="image/*" multiple hidden>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</label></p>
    <p class="small">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© (‡πÉ‡∏ä‡πâ Tesseract.js ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</p>
  </div>

  <div id="jobs"></div>

  <div class="row">
    <button id="download" class="btn" disabled>üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
    <button id="copy" class="btn sec" disabled>üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON</button>
  </div>

  <div class="card">
    <div class="small">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå JSON</div>
    <pre id="out">{}</pre>
  </div>

<script>
const outEl = document.getElementById('out');
const jobsEl = document.getElementById('jobs');
const downloadBtn = document.getElementById('download');
const copyBtn = document.getElementById('copy');

let results = []; // [{imageName, day, periods, rawText, lines[]}]

const TH_DAYS = ["‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå","‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå","‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£","‡∏û‡∏∏‡∏ò","‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ","‡∏®‡∏∏‡∏Å‡∏£‡πå","‡πÄ‡∏™‡∏≤‡∏£‡πå"];

// ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏•‡∏Ç‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡∏≤‡∏£‡∏ö‡∏¥‡∏Å
function thNumToAr(s){
  const map = {'‡πê':'0','‡πë':'1','‡πí':'2','‡πì':'3','‡πî':'4','‡πï':'5','‡πñ':'6','‡πó':'7','‡πò':'8','‡πô':'9'};
  return s.replace(/[‡πê-‡πô]/g, d => map[d] ?? d);
}

// ‡πÄ‡∏î‡∏≤ "‡∏ß‡∏±‡∏ô" ‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©
function detectDay(text){
  for (const d of TH_DAYS){
    const re = new RegExp(d, 'g');
    if (re.test(text)) return d;
  }
  return ""; // ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
}

// ‡πÄ‡∏î‡∏≤ period-time ‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô 6 ‡∏Ñ‡∏≤‡∏ö)
function detectPeriods(text){
  const t = thNumToAr(text);
  // ‡∏à‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏ö‡∏ö 08:30-09:30 ‡∏´‡∏£‡∏∑‡∏≠ 08.30-09.30
  const re = /(\d{1,2}[:.]\d{2})\s*[-‚Äì]\s*(\d{1,2}[:.]\d{2})/g;
  const found = [];
  let m;
  while ((m = re.exec(t)) !== null){
    found.push(m[0].replace(/\s/g,'').replace(/\./g,':'));
  }
  // ‡∏Å‡∏£‡∏≠‡∏á‡∏ã‡πâ‡∏≥ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏∑‡πà‡∏ô
  const uniq = [...new Set(found)];
  if (uniq.length >= 4) return uniq; // ‡∏û‡∏≠‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏à‡∏≠
  // fallback default 6 ‡∏Ñ‡∏≤‡∏ö
  return ["08:30-09:30","09:30-10:30","10:30-11:30","12:30-13:30","13:30-14:30","14:30-15:30"];
}

// ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏™‡∏∞‡∏≠‡∏≤‡∏î
function textToLines(text){
  return text
    .split(/\r?\n/)
    .map(s => s.trim())
    .filter(Boolean);
}

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å OCR ‡∏ó‡∏µ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå
async function ocrOne(file){
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <div><b>${file.name}</b></div>
    <div class="row"><progress max="1" value="0"></progress><span class="small" id="st">‡πÄ‡∏£‡∏¥‡πà‡∏° OCR...</span></div>
    <div class="small" id="d"></div>
  `;
  jobsEl.appendChild(card);
  const prog = card.querySelector('progress');
  const st = card.querySelector('#st');
  const d = card.querySelector('#d');

  const worker = await Tesseract.createWorker("tha+eng", 1, {
    logger: m => {
      if (m.status === 'recognizing text'){
        prog.value = m.progress;
        st.textContent = `OCR ${(m.progress*100).toFixed(0)}%`;
      }
    }
  });

  let text = "";
  try{
    const { data } = await worker.recognize(file);
    text = data.text || "";
    await worker.terminate();
    st.innerHTML = `<span class="ok">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>`;
  }catch(e){
    st.innerHTML = `<span class="err">‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>`;
    d.textContent = e?.message || e;
    try{ await worker.terminate(); }catch(_){}
  }

  const lines = textToLines(text);
  const day = detectDay(text);
  const periods = detectPeriods(text);

  results.push({
    imageName: file.name,
    day,
    periods,
    rawText: text,
    lines
  });

  renderJSON();
}

function renderJSON(){
  const payload = {
    generated_at: new Date().toISOString(),
    pages: results
  };
  outEl.textContent = JSON.stringify(payload, null, 2);
  const enabled = results.length > 0;
  downloadBtn.disabled = !enabled;
  copyBtn.disabled = !enabled;
}

downloadBtn.addEventListener('click', ()=>{
  const blob = new Blob([outEl.textContent], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `timetable_ocr_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
});

copyBtn.addEventListener('click', async ()=>{
  await navigator.clipboard.writeText(outEl.textContent);
  copyBtn.textContent = '‚úÖ ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
  setTimeout(()=> copyBtn.textContent = 'üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å JSON', 1200);
});

// ‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', e => {
  results = [];
  renderJSON();
  [...e.target.files].forEach(ocrOne);
});

// drag & drop
const drop = document.getElementById('drop');
drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', e => {
  e.preventDefault();
  drop.classList.remove('drag');
  const files = [...e.dataTransfer.files].filter(f => f.type.startsWith('image/'));
  if (!files.length) return;
  results = [];
  renderJSON();
  files.forEach(ocrOne);
});
</script>
</body>
</html>
